# 🗂️ Node Filesystem Reference

This document provides a comprehensive reference of all files and directories created on each cluster node, organized by the layer responsible for creating them.

## 📋 Quick Overview

Each Dynia cluster node contains two distinct layers of files:

- **🏗️ Infrastructure Layer**: Created by `dynia cluster prepare` - consistent across all nodes
- **🚀 Application Layer**: Created by `dynia cluster deployment create` - services deployed to all nodes

## 🏗️ Infrastructure Layer Files

### Created by: `dynia cluster prepare <cluster>`

These files provide the foundation for high availability clustering and are identical across all nodes in a cluster.

#### Docker Engine & Networks

```bash
# Docker system files
/var/lib/docker/              # Docker runtime data
/etc/docker/                  # Docker daemon configuration
/usr/bin/docker               # Docker CLI binary
/usr/bin/docker-compose       # Docker Compose binary

# Docker networks
docker network ls
# Shows: edge (custom bridge network for services)
```

#### Base Directory Structure

```bash
/opt/dynia/                   # Main Dynia directory
├── caddy/                    # Caddy reverse proxy configs
├── haproxy/                  # HAProxy load balancer configs
└── compose/                  # Application service deployments (initially empty)
```

**Note**: The deprecated `/opt/dynia/placeholder/` directory is no longer created or used.

#### Caddy Reverse Proxy

```bash
/opt/dynia/caddy/
├── Caddyfile                 # Generated from template - reverse proxy rules
└── docker-compose.yml       # Caddy container service definition

# Log directory
/var/log/caddy/               # Caddy access logs (created by container)
```

**Caddyfile Contents** (example):
```caddy
# Dynia Caddyfile - managed by Dynia CLI
# This file is automatically generated and updated by Dynia

node1.example.com {
    reverse_proxy http://dynia-placeholder:80
    
    # Health check endpoint
    handle_path /dynia-health {
        respond "Dynia Node: node1 - OK" 200
    }
    
    # Security headers and compression
    header {
        X-Frame-Options DENY
        X-Content-Type-Options nosniff
        Referrer-Policy strict-origin-when-cross-origin
        X-XSS-Protection "1; mode=block"
    }
    encode zstd gzip
    
    log {
        output file /var/log/caddy/access.log
        format json
    }
}
```

#### HAProxy Load Balancer

```bash
/opt/dynia/haproxy/
├── haproxy.cfg               # Generated HAProxy configuration
├── docker-compose.yml       # HAProxy container service definition
└── certs/                    # SSL certificates directory
    ├── default.pem           # Combined certificate and private key
    ├── default.crt           # Certificate only
    └── default.key           # Private key only
```

**HAProxy Configuration** (key sections):
```bash
# Global settings
global
    daemon
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    
# Frontend - SSL termination
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/default.pem
    redirect scheme https unless { ssl_fc }
    
# Backend - All cluster nodes
backend caddy_backends  
    balance roundrobin
    option httpchk GET /dynia-health
    server node1 10.0.1.1:8080 check inter 5s fall 3 rise 2
    server node2 10.0.1.2:8080 check inter 5s fall 3 rise 2
    server node3 10.0.1.3:8080 check inter 5s fall 3 rise 2
```

**System HAProxy Alternative** (when not using Docker):
```bash
/etc/haproxy/
├── haproxy.cfg               # System HAProxy configuration
└── backup/                   # Configuration backups
```

#### Keepalived High Availability

```bash
/etc/keepalived/
├── keepalived.conf           # VRRP configuration (node-specific)
└── scripts/                  # Health check scripts
    └── check_haproxy.sh      # HAProxy health monitoring script
```

**Keepalived Configuration** (example for active node):
```bash
# keepalived configuration for Dynia HA cluster
# Generated for node: brave-panda
# Cluster: myapp
# Role: active (priority: 100)

global_defs {
    router_id brave-panda
    script_user root
    enable_script_security
}

# Health check script
vrrp_script chk_haproxy {
    script "/etc/keepalived/scripts/check_haproxy.sh"
    interval 2
    weight -50
    fall 2
    rise 2
}

# VRRP instance for Reserved IP management
vrrp_instance VI_1 {
    state MASTER                    # MASTER for active, BACKUP for standby
    interface eth0                  # Primary network interface
    virtual_router_id 51            # Same across all nodes in cluster
    priority 100                    # Higher = preferred (100, 90, 80...)
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass myapp-secret
    }
    
    virtual_ipaddress {
        198.51.100.10              # Reserved IP address
    }
    
    track_script {
        chk_haproxy
    }
}
```

#### System Logs

```bash
/var/log/
├── caddy/                    # Caddy proxy logs
│   └── access.log           # HTTP requests (JSON format)
├── haproxy.log              # HAProxy access and error logs  
├── keepalived.log           # Failover events and health checks
└── docker/                  # Docker daemon logs
```

## 🚀 Application Layer Files

### Created by: `dynia cluster deployment create <cluster>`

These files contain your deployed services and are created on ALL cluster nodes for proper load balancing.

#### Service Deployment Structure

```bash
/opt/dynia/compose/
└── [service-domain]/             # One directory per deployed service
    ├── docker-compose.yml        # Service container definition
    ├── .env                      # Environment variables (if needed)
    ├── config/                   # Service-specific configurations
    │   ├── nginx.conf           # Custom configs
    │   └── app.yaml            # Application settings
    └── data/                     # Persistent data volumes (if needed)
```

#### Example: Placeholder Service

**Created by**: `dynia cluster deployment create --name myapp --placeholder`

```bash
/opt/dynia/compose/
└── dynia-placeholder-myapp.example.com/
    └── docker-compose.yml
```

**docker-compose.yml contents**:
```yaml
version: '3.8'

services:
  placeholder:
    image: nginx:alpine
    container_name: dynia-placeholder-myapp
    networks:
      - edge
    environment:
      - NODE_NAME=${NODE_NAME:-unknown}
    ports:
      - "8081:80"
    volumes:
      - ./index.html:/usr/share/nginx/html/index.html:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  edge:
    external: true
```

#### Example: Custom Application

**Created by**: `dynia cluster deployment create --name myapp --compose ./app.yml --domain api.example.com`

```bash
/opt/dynia/compose/
└── api.example.com/
    ├── docker-compose.yml        # Your provided compose file
    ├── .env                      # Generated environment variables
    └── config/                   # Any config files your app needs
        └── database.yml
```

## 📁 File Ownership & Permissions

### Infrastructure Files

```bash
# Caddy and HAProxy configs
chown root:root /opt/dynia/caddy/*
chmod 644 /opt/dynia/caddy/Caddyfile
chmod 644 /opt/dynia/caddy/docker-compose.yml

# HAProxy certificates (sensitive)
chown root:root /opt/dynia/haproxy/certs/*
chmod 600 /opt/dynia/haproxy/certs/*.key    # Private keys
chmod 644 /opt/dynia/haproxy/certs/*.crt    # Certificates
chmod 600 /opt/dynia/haproxy/certs/*.pem    # Combined files

# Keepalived configuration
chown root:root /etc/keepalived/keepalived.conf
chmod 644 /etc/keepalived/keepalived.conf
chmod +x /etc/keepalived/scripts/check_haproxy.sh
```

### Application Files

```bash
# Service deployment files
chown root:docker /opt/dynia/compose/*/
chmod 644 /opt/dynia/compose/*/docker-compose.yml
chmod 600 /opt/dynia/compose/*/.env           # Environment files (sensitive)
```

## 🔄 File Lifecycle Management

### When Files are Created

| Command | Files Created | Purpose |
|---------|---------------|---------|
| `dynia cluster prepare` | Infrastructure layer | Node preparation with HA services |
| `dynia cluster deployment create` | Application layer | Service deployment to all nodes |
| `dynia cluster certificate provision` | SSL certificates | HAProxy SSL termination |

### File Modification Events

```bash
# Infrastructure updates (rare)
dynia cluster prepare myapp --force          # Recreates infrastructure configs

# Application updates (common)
dynia cluster deployment create myapp --compose ./v2.yml --domain api.example.com
# → Updates /opt/dynia/compose/api.example.com/

# Certificate renewal (automatic via Cloudflare Origin)
dynia cluster certificate provision myapp    # Updates HAProxy certificates
```

### Cleanup Procedures

```bash
# Remove a specific service deployment
rm -rf /opt/dynia/compose/api.example.com/
docker compose -f /opt/dynia/compose/api.example.com/docker-compose.yml down

# Complete node reset (destructive)
rm -rf /opt/dynia/                           # Remove all Dynia files
docker system prune -af                      # Remove all containers/images
systemctl stop keepalived haproxy           # Stop system services
```

## 🔍 Configuration Templates

### Infrastructure Files Generation

All infrastructure configuration files are generated from templates in the Dynia codebase:

```bash
# Template locations (in Dynia source):
packages/dynia/src/shared/templates/
├── Caddyfile.template           # Caddy reverse proxy
├── haproxy.cfg                  # HAProxy load balancer  
└── system-haproxy.cfg           # System HAProxy alternative

packages/dynia/src/shared/docker/
├── caddy-compose.yml            # Caddy Docker service
├── haproxy-compose.yml          # HAProxy Docker service
└── placeholder-compose.yml      # Test service template
```

### Template Variables

Common template variables used across configurations:

- `{{DOMAIN}}` - Node domain (e.g., `node1.example.com`)
- `{{NODE_NAME}}` - Node identifier (e.g., `brave-panda`)
- `{{CLUSTER_NAME}}` - Cluster name (e.g., `myapp`)
- `{{TARGET_SERVICE}}` - Service container name
- `{{TARGET_PORT}}` - Service port mapping
- `{{BACKEND_SERVERS}}` - All cluster nodes for load balancing

## 🚨 Important Notes

### File Consistency Requirements

**CRITICAL**: These files must be identical across all cluster nodes:
- **Caddy configuration**: Same routing rules
- **HAProxy backend pools**: All cluster nodes listed
- **Docker network setup**: Consistent `edge` network
- **SSL certificates**: Same certificates on all nodes

**NODE-SPECIFIC**: These files vary per node:
- **Keepalived priority**: Different values (100, 90, 80...)
- **Keepalived role**: MASTER vs BACKUP
- **Node identification**: Unique names in health endpoints

### Maintenance Best Practices

1. **Never edit generated files manually** - Use Dynia CLI commands
2. **Always backup before changes** - Especially certificates and configs
3. **Verify consistency across nodes** - Use `dynia cluster config inspect`
4. **Monitor log files** - For health and performance issues
5. **Test failover regularly** - Ensure keepalived is working

## 📊 File Size Expectations

| Directory | Typical Size | Growth Pattern |
|-----------|-------------|----------------|
| `/opt/dynia/caddy/` | < 1MB | Static (configs only) |
| `/opt/dynia/haproxy/` | 1-5MB | Grows with certificates |
| `/opt/dynia/compose/` | Varies | Grows with each service |
| `/var/log/caddy/` | 10MB-1GB | Rotated logs |
| `/var/log/` (HAProxy) | 10MB-1GB | Rotated logs |
| `/etc/keepalived/` | < 1MB | Static configuration |

## 🔗 Related Documentation

- [Infrastructure Deep Dive](infrastructure.md) - Technical architecture details
- [Getting Started Guide](getting-started.md) - Basic cluster setup
- [Troubleshooting Guide](troubleshooting.md) - Common file-related issues
- [Architecture & Design](architecture.md) - System overview

---

This reference should help you understand exactly what files exist on your cluster nodes and their purposes. For operational questions, see the troubleshooting guide or use `dynia cluster config inspect` to examine live configurations.