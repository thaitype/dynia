# Dynia CLI

A powerful command-line tool for automated cloud infrastructure management and deployment. Dynia simplifies the creation and management of cloud nodes with integrated DNS, HTTPS certificates, and health monitoring.

## ‚ú® Features

- **üîë SSH Key Management**: Automated SSH key generation and DigitalOcean integration
- **‚òÅÔ∏è Cloud Node Creation**: One-command DigitalOcean droplet provisioning with Ubuntu 22.04
- **üåê DNS Automation**: Automatic Cloudflare DNS A record creation and propagation
- **üîí HTTPS Certificates**: Automated SSL/TLS certificate generation via Caddy
- **üê≥ Docker Infrastructure**: Containerized services with Caddy proxy and health monitoring
- **üîç Two-Sided Health Checks**: Internal container validation + public accessibility testing
- **üîÑ Intelligent Recovery**: Progressive state saving and automatic repair capabilities
- **‚ö° Built-in Resilience**: Retry logic for transient failures and network issues

## üöÄ Quick Start

### Prerequisites

- **DigitalOcean Account**: For droplet creation and management
- **Cloudflare Account**: For DNS management and domain configuration  
- **Domain**: A domain registered and managed through Cloudflare
- **Node.js 18+**: For running the CLI tool

### Installation

```bash
# Clone the repository
git clone https://github.com/thaitype/dynia.git
cd dynia

# Install dependencies
pnpm install

# Build the project
pnpm build

# Navigate to example directory
cd examples/basic
```

### Environment Setup

Create a `.env` file in your project directory:

```bash
# Required: DigitalOcean API Token
DYNIA_DO_TOKEN=dop_v1_your_digitalocean_token_here

# Required: Cloudflare API Token (with Zone:Edit permissions)
DYNIA_CF_TOKEN=your_cloudflare_api_token_here

# Required: Cloudflare Zone ID (found in your domain's dashboard)
DYNIA_CF_ZONE_ID=your_cloudflare_zone_id_here

# Required: SSH Key ID (generated by 'dynia ssh create' command)
DYNIA_SSH_KEY_ID=your_ssh_key_id_here
```

### Configuration

Dynia uses default configuration for DigitalOcean resources:

- **Region**: `nyc3` (New York)
- **Droplet Size**: `s-1vcpu-1gb` (1 vCPU, 1GB RAM)
- **Image**: `ubuntu-22-04-x64` (Ubuntu 22.04 LTS)
- **Domain**: `thaitype.dev` (configurable)

## üìñ Commands Reference

### SSH Key Management

#### Create SSH Key
```bash
# Create SSH key with default name 'dynia'
pnpm dynia ssh create

# Create SSH key with custom name
pnpm dynia ssh create --key-name myproject

# Recreate existing SSH key
pnpm dynia ssh create --force

# Create key and display environment variable
pnpm dynia ssh create --output-env
```

#### List SSH Keys
```bash
# Show all SSH keys in your DigitalOcean account
pnpm dynia ssh list
```

### Node Management

#### Create Node
```bash
# Create a single node
pnpm dynia node create --name webserver

# Create numbered node
pnpm dynia node create --name api --number 1
# Results in: api-1.yourdomain.com

# Create node with custom health check path
pnpm dynia node create --name app --health-path /health
```

#### List Nodes
```bash
# Show all nodes and their status
pnpm dynia node list
```

#### Repair Node
```bash
# Check node status only
pnpm dynia node repair webserver --check-only

# Repair node with confirmation prompt
pnpm dynia node repair webserver

# Force repair without confirmation
pnpm dynia node repair webserver --force
```

## üîß Complete Workflow

### 1. Initial Setup
```bash
# Step 1: Create and upload SSH key to DigitalOcean
pnpm dynia ssh create --output-env

# Step 2: Copy the DYNIA_SSH_KEY_ID to your .env file
echo "DYNIA_SSH_KEY_ID=12345678" >> .env

# Step 3: Verify SSH key was created
pnpm dynia ssh list
```

### 2. Node Creation
```bash
# Create your first node
pnpm dynia node create --name myapp

# Monitor the process - you'll see:
# ‚úÖ DigitalOcean droplet created
# ‚úÖ DNS A record created  
# ‚úÖ DNS propagation verified
# ‚úÖ Docker infrastructure deployed
# ‚úÖ Health check passed - node is fully operational
```

### 3. Verification
```bash
# Check node status
pnpm dynia node list

# Your node should show as 'active'
# Access your node at: https://myapp.yourdomain.com
```

### 4. Troubleshooting
```bash
# If something goes wrong, use repair
pnpm dynia node repair myapp --check-only

# View detailed infrastructure status
pnpm dynia node repair myapp --force
```

## üèóÔ∏è Infrastructure Details

### What Gets Created

When you create a node, Dynia automatically provisions:

1. **DigitalOcean Droplet**
   - Ubuntu 22.04 LTS server
   - Docker and Docker Compose installed
   - SSH access configured

2. **Cloudflare DNS**
   - A record: `nodename.yourdomain.com ‚Üí droplet_ip`
   - 5-minute TTL for faster propagation

3. **Docker Services**
   - **Caddy Proxy**: Handles HTTPS certificates and routing
   - **Placeholder Service**: Default nginx container serving a welcome page
   - **Edge Network**: Docker network for service communication

4. **Security Configuration**
   - Automatic HTTPS/SSL certificates via Let's Encrypt
   - Security headers (HSTS, CSP, etc.)
   - Firewall-friendly configuration

### Node States

Nodes progress through these states during creation:

- `droplet-created`: DigitalOcean VM is running
- `dns-configured`: DNS record created in Cloudflare  
- `dns-ready`: DNS propagation verified
- `infrastructure-ready`: Docker services deployed
- `active`: All health checks passed, fully operational

### Health Validation

Dynia performs comprehensive two-sided health checks:

**Internal Health Check:**
- Container state verification
- Docker service connectivity
- Internal network testing
- Service readiness validation

**Public Health Check:**
- DNS resolution from multiple resolvers (1.1.1.1, 8.8.8.8)
- HTTPS endpoint accessibility
- SSL certificate validation
- Complete request/response cycle testing

## üîß Advanced Usage

### Repair and Recovery

The repair system can recover from various failure scenarios:

```bash
# Common repair scenarios:
pnpm dynia node repair myapp --force

# Repairs can handle:
# - Docker installation failures
# - Service deployment issues  
# - Network connectivity problems
# - Certificate generation delays
# - DNS propagation timeouts
```

### Custom Configuration

Environment variables for advanced configuration:

```bash
# Custom domain (default: thaitype.dev)
DYNIA_DOMAIN=mydomain.com

# Custom DigitalOcean region (default: nyc3)  
DYNIA_DO_REGION=sfo3

# Custom droplet size (default: s-1vcpu-1gb)
DYNIA_DO_SIZE=s-2vcpu-2gb
```

## üêõ Troubleshooting

### Common Issues

1. **SSH Connection Timeout**
   ```bash
   # Verify SSH key is properly configured
   pnpm dynia ssh list
   
   # Check droplet firewall settings in DigitalOcean console
   ```

2. **DNS Propagation Slow**
   ```bash
   # DNS can take time - repair will handle it
   pnpm dynia node repair mynode --force
   ```

3. **Certificate Generation Failed**
   ```bash
   # Usually resolves automatically with repair
   pnpm dynia node repair mynode --force
   ```

4. **Container Health Check Failed**
   ```bash
   # Check detailed status
   pnpm dynia node repair mynode --check-only
   ```

### Debug Mode

```bash
# Enable verbose logging
pnpm dynia node create --name debug-node --verbose

# Dry run mode (test without actual changes)
pnpm dynia node create --name test-node --dry-run
```

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable  
5. Submit a pull request

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üôã Support

- **Issues**: [GitHub Issues](https://github.com/thaitype/dynia/issues)
- **Documentation**: This README and command help (`pnpm dynia --help`)
- **Examples**: Check the `examples/` directory

---

**Made with ‚ù§Ô∏è by the Dynia team**